# READ-ONLY: Use 'exo' CLI to modify this file.
# Implementation Plan

[phase]
id = "01kgbg66ynthsrx3mqn2fzadxn"
title = "Phase 3: Calibration Loop"
rfcs = ["029"]

[plan]

[[plan.goals]]
id = "delete-calibration-manager"
title = "Delete orphaned CalibrationManager code (RFC 029 removed calibration)"

[[plan.goals]]
id = "fix-underestimation"
title = "Fix ~13% token underestimation in provideTokenCount (add per-message overhead)"

[[plan.goals]]
id = "token-diagnostics"
title = "Add TOKEN_ESTIMATED/TOKEN_ACTUAL events to TreeDiagnostics for AI self-review"

[[plan.goals]]
id = "narrative-tokens"
title = "Extend narrative tool with --tokens flag for estimation accuracy analysis"

[[plan.goals.tasks]]
id = "NT-1"
title = "Extend AgentSnapshotEntry to include estimatedInputTokens"
status = "completed"
completed_at = "2026-02-02T22:27:51.435507085+00:00"
completion_log = "Added estimatedInputTokens?: number to AgentSnapshotEntry interface in both tree-diagnostics.ts and analyze-agent-logs.ts. Added capture of agent.estimatedInputTokens in snapshot creation."

[[plan.goals.tasks]]
id = "NT-2"
title = "Add --tokens/-t flag to CLI argument parsing"
status = "completed"
completed_at = "2026-02-02T22:27:55.685052792+00:00"
completion_log = "Added --tokens/-t flag parsing in main() function. Flag is filtered from args and passed to formatNarrative."

[[plan.goals.tasks]]
id = "NT-3"
title = "Define interfaces for token accuracy analysis"
status = "completed"
completed_at = "2026-02-02T22:28:01.128985872+00:00"
completion_log = "Added TokenAccuracyEntry interface (agentId, agentName, estimated, actual, ratio, errorPercent) and TokenAccuracySummary interface (entries array + aggregate stats: totalEstimated, totalActual, overallRatio, overallErrorPercent, agentsWithEstimates, agentsWithoutEstimates)."

[[plan.goals.tasks]]
id = "NT-4"
title = "Extract token accuracy data from events"
status = "completed"
completed_at = "2026-02-02T22:28:06.247093038+00:00"
completion_log = "Implemented extractTokenAccuracy(events) function that processes AGENT_SNAPSHOT events to build per-agent token accuracy data. Tracks estimated vs actual input tokens, calculates ratios and error percentages, and aggregates totals."

[[plan.goals.tasks]]
id = "NT-5"
title = "Format token accuracy for narrative output"
status = "completed"
completed_at = "2026-02-02T22:28:12.232401913+00:00"
completion_log = "Implemented formatTokenAccuracy(summary) function that formats a table with columns: Agent, Estimated, Actual, Ratio, Error%. Shows per-agent rows and aggregate totals. Handles edge cases (no data, agents without estimates)."

[[plan.goals.tasks]]
id = "NT-6"
title = "Integrate --tokens output into formatNarrative"
status = "completed"
completed_at = "2026-02-02T22:28:17.385413245+00:00"
completion_log = "Modified formatNarrative to accept showTokens parameter. When true, calls extractTokenAccuracy and formatTokenAccuracy to append token accuracy section. Also added standalone --tokens mode in main() for token-only output."

[[plan.goals.tasks]]
id = "NT-7"
title = "Update script documentation"
status = "completed"
completed_at = "2026-02-02T22:28:22.236104800+00:00"
completion_log = "Updated script header documentation to include --tokens/-t flag description. Documentation now shows all three flags: --narrative/-n, --session-only/-s, and --tokens/-t."

[[plan.goals]]
id = "cleanup-dead-code"
title = "Delete orphaned TokenCache.cacheActual and CallSequenceTracker unused paths"

[[plan.goals]]
id = "safe-serialize"
title = "Add safe serialization utilities to prevent JSON.stringify stack overflow"

[[plan.goals.tasks]]
id = "SS-1"
title = "Add safe-stable-stringify dependency to package.json"
status = "completed"
completed_at = "2026-02-02T23:03:34.783018672+00:00"
completion_log = "Added safe-stable-stringify ^2.5.0 to dependencies via pnpm add"

[[plan.goals.tasks]]
id = "SS-2"
title = "Create src/utils/serialize.ts with safeJsonStringify() and safeInspect() wrappers"
status = "completed"
completed_at = "2026-02-02T23:04:08.549702732+00:00"
completion_log = "Created src/utils/serialize.ts with safeJsonStringify(), safeInspect(), and tryStringify() utilities"

[[plan.goals.tasks]]
id = "SS-3"
title = "Migrate tree-diagnostics.ts JSONL writer to use safeJsonStringify"
status = "completed"
completed_at = "2026-02-02T23:04:40.492437897+00:00"
completion_log = "Migrated tree-diagnostics.ts to use safeJsonStringify for JSONL output"

[[plan.goals.tasks]]
id = "SS-4"
title = "Migrate forensic-capture.ts JSONL writer to use safeJsonStringify"
status = "completed"
completed_at = "2026-02-02T23:05:28.026893719+00:00"
completion_log = "Migrated forensic-capture.ts JSONL writer to use safeJsonStringify"

[[plan.goals.tasks]]
id = "SS-5"
title = "Fix tokens/counter.ts JSON.stringify(part.input) - VS Code object risk"
status = "completed"
completed_at = "2026-02-02T23:06:00.489660524+00:00"
completion_log = "Fixed tokens/counter.ts to use tryStringify for part.input (VS Code object)"

[[plan.goals.tasks]]
id = "SS-6"
title = "Fix extension.ts JSON.stringify(chunk.input) - VS Code object risk"
status = "completed"
completed_at = "2026-02-02T23:06:34.833278911+00:00"
completion_log = "Fixed extension.ts to use tryStringify for chunk.input (VS Code object)"

[[plan.goals.tasks]]
id = "SS-7"
title = "Migrate other JSONL writers (logger.ts, index-writer.ts, request-logger.ts)"
status = "completed"
completed_at = "2026-02-02T23:07:58.441902418+00:00"
completion_log = "Migrated JSONL writers in logger.ts, index-writer.ts, and request-logger.ts to use safeJsonStringify"

[[plan.goals.tasks]]
id = "SS-8"
title = "Build and test extension to verify no regressions"
status = "completed"
completed_at = "2026-02-02T23:08:35.384763600+00:00"
completion_log = "Build passes. 3 pre-existing test failures in models.test.ts (unrelated to serialization changes). 356 tests pass."
# Goals contain tasks. Use 'exo-add-task' to add tasks to goals.


[verification]
automated = ["Run scripts/verify-phase.sh"]
manual = []
