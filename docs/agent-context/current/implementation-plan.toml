# READ-ONLY: Use 'exo' CLI to modify this file.
# Implementation Plan

[phase]
id = "01kgbg66ynthsrx3mqn2fzadxn"
title = "Phase 3: Calibration Loop"
rfcs = ["029"]

[plan]

[[plan.goals]]
id = "delete-calibration-manager"
title = "Delete orphaned CalibrationManager code (RFC 029 removed calibration)"

[[plan.goals]]
id = "fix-underestimation"
title = "Fix ~13% token underestimation in provideTokenCount (add per-message overhead)"

[[plan.goals]]
id = "token-diagnostics"
title = "Add TOKEN_ESTIMATED/TOKEN_ACTUAL events to TreeDiagnostics for AI self-review"

[[plan.goals]]
id = "narrative-tokens"
title = "Extend narrative tool with --tokens flag for estimation accuracy analysis"

[[plan.goals.tasks]]
id = "NT-1"
title = "Extend AgentSnapshotEntry to include estimatedInputTokens"
status = "completed"
completed_at = "2026-02-02T22:27:51.435507085+00:00"
completion_log = "Added estimatedInputTokens?: number to AgentSnapshotEntry interface in both tree-diagnostics.ts and analyze-agent-logs.ts. Added capture of agent.estimatedInputTokens in snapshot creation."

[[plan.goals.tasks]]
id = "NT-2"
title = "Add --tokens/-t flag to CLI argument parsing"
status = "completed"
completed_at = "2026-02-02T22:27:55.685052792+00:00"
completion_log = "Added --tokens/-t flag parsing in main() function. Flag is filtered from args and passed to formatNarrative."

[[plan.goals.tasks]]
id = "NT-3"
title = "Define interfaces for token accuracy analysis"
status = "completed"
completed_at = "2026-02-02T22:28:01.128985872+00:00"
completion_log = "Added TokenAccuracyEntry interface (agentId, agentName, estimated, actual, ratio, errorPercent) and TokenAccuracySummary interface (entries array + aggregate stats: totalEstimated, totalActual, overallRatio, overallErrorPercent, agentsWithEstimates, agentsWithoutEstimates)."

[[plan.goals.tasks]]
id = "NT-4"
title = "Extract token accuracy data from events"
status = "completed"
completed_at = "2026-02-02T22:28:06.247093038+00:00"
completion_log = "Implemented extractTokenAccuracy(events) function that processes AGENT_SNAPSHOT events to build per-agent token accuracy data. Tracks estimated vs actual input tokens, calculates ratios and error percentages, and aggregates totals."

[[plan.goals.tasks]]
id = "NT-5"
title = "Format token accuracy for narrative output"
status = "completed"
completed_at = "2026-02-02T22:28:12.232401913+00:00"
completion_log = "Implemented formatTokenAccuracy(summary) function that formats a table with columns: Agent, Estimated, Actual, Ratio, Error%. Shows per-agent rows and aggregate totals. Handles edge cases (no data, agents without estimates)."

[[plan.goals.tasks]]
id = "NT-6"
title = "Integrate --tokens output into formatNarrative"
status = "completed"
completed_at = "2026-02-02T22:28:17.385413245+00:00"
completion_log = "Modified formatNarrative to accept showTokens parameter. When true, calls extractTokenAccuracy and formatTokenAccuracy to append token accuracy section. Also added standalone --tokens mode in main() for token-only output."

[[plan.goals.tasks]]
id = "NT-7"
title = "Update script documentation"
status = "completed"
completed_at = "2026-02-02T22:28:22.236104800+00:00"
completion_log = "Updated script header documentation to include --tokens/-t flag description. Documentation now shows all three flags: --narrative/-n, --session-only/-s, and --tokens/-t."

[[plan.goals]]
id = "cleanup-dead-code"
title = "Delete orphaned TokenCache.cacheActual and CallSequenceTracker unused paths"
# Goals contain tasks. Use 'exo-add-task' to add tasks to goals.


[verification]
automated = ["Run scripts/verify-phase.sh"]
manual = []
