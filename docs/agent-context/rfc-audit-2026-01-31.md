# RFC Audit & Plan Restructuring Analysis

**Date**: 2026-01-31  
**Status**: Ready for plan scaffolding  
**Branch**: `feat/token-status-bar`

---

## Executive Summary

The current `plan.toml` is **significantly out of sync** with reality:

- OpenResponses is the primary execution path, but plan treats RFC 004 as "triage"
- 3+ RFCs are complete but not tracked (013, 019-refactor, portions of 014)
- RFC numbering inconsistent (plan uses "003a/b", "005a/b/c" vs actual file IDs)
- Many stage-0 RFCs exist but aren't in plan

**Recommendation**: Re-scaffold plan from scratch using this analysis.

---

## RFC Status Matrix

| RFC       | Title                             | Stage | Implementation            | Action                               |
| --------- | --------------------------------- | ----- | ------------------------- | ------------------------------------ |
| **004**   | OpenResponses Integration         | 0     | âœ… Complete               | **Retire** - superseded by 016       |
| **016**   | OpenResponses Architecture        | 0     | âœ… Complete               | **Promote** to Stage 3               |
| **019**   | Provider Module Refactoring       | 0     | âœ… Complete               | **Promote** to Stage 3               |
| **008**   | High-Fidelity Model Mapping       | 3     | âœ… Complete               | Keep                                 |
| **014**   | Enrichment Refinement             | 0     | âœ… Complete               | **Fold into 008** as Phase 5         |
| **013**   | Tool Call Truncation              | 0     | âœ… Code exists, not wired | **Consolidate** with 00024/00025     |
| **00024** | Native Tool History Migration     | 0     | âš¡ Partial                | **Consolidate** â†’ Tool History RFC   |
| **00025** | Unified Tool History Architecture | 0     | âš¡ Partial                | **Consolidate** â†’ Tool History RFC   |
| **009**   | Token Counting                    | 0     | âš¡ Mostly complete        | Keep - core priority                 |
| **010**   | Smart Context Compaction          | 0     | âŒ Not started            | **Fold into 009** as Phase 2         |
| **019**   | Pause Issue                       | 0     | âš¡ Mitigations only       | Keep - needs strategy                |
| **003**   | Streaming Adapter                 | 3     | ğŸ”„ Different impl         | **Re-scope** to OpenResponses        |
| **006**   | Token Estimation                  | 3     | âœ… In extension           | **Re-scope** - no package extraction |
| **015**   | Logging Improvements              | 0     | âš¡ Partial                | **Consolidate** with 00020           |
| **00020** | Hierarchical Logging              | 0     | âŒ Not started            | **Consolidate** with 015             |
| **00022** | SSE State Machine Mapping         | 0     | âœ… Complete               | **Promote** to spec/doc              |
| **017**   | OpenResponses Cleanup             | 0     | âš¡ Partial                | **Narrow** to logging audit          |
| **018**   | Status Bar Metadata               | 0     | âš¡ Partial (capture done) | Keep                                 |
| **005**   | Configuration                     | 1     | âš¡ Partial                | Keep                                 |
| **011**   | Authentication                    | 0     | âš¡ Partial                | Keep                                 |
| **012**   | Telemetry                         | 0     | âŒ Not started            | Keep (if desired)                    |
| **001**   | Standalone Repo                   | 0     | âŒ Not started            | Keep (business decision)             |
| **002**   | Branding                          | 0     | âŒ Not started            | Keep                                 |
| **007**   | Migration                         | 0     | âŒ Not started            | Keep                                 |
| **00021** | Proposed APIs Research            | 0     | âŒ Not started            | **Consolidate** with 00023           |
| **00023** | Insiders Build Strategy           | 0     | âŒ Not started            | **Consolidate** with 00021           |

---

## Consolidation Actions

| Action          | Source RFCs                     | Result                             |
| --------------- | ------------------------------- | ---------------------------------- |
| **Consolidate** | 013 + 00024 + 00025             | â†’ "Tool History & Truncation"      |
| **Consolidate** | 015 + 00020                     | â†’ "Logging Architecture"           |
| **Consolidate** | 00021 + 00023                   | â†’ "Proposed APIs & Insiders Build" |
| **Fold**        | 014 â†’ 008                       | Phase 5 of Model Mapping           |
| **Fold**        | 010 â†’ 009                       | Phase 2 of Token Counting          |
| **Retire**      | 004                             | Superseded by 016                  |
| **Retire**      | 003 (withdrawn), 005 (archived) | Already withdrawn                  |
| **Re-scope**    | 003, 006                        | Remove package extraction goal     |

---

## Dependency Graph

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Vercel Transition (001/002/007) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                    â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Config/Auth/Telem â”‚    â”‚ Proposed APIs      â”‚    â”‚ Status Bar (018)   â”‚
â”‚ (005/011/012)     â”‚    â”‚ (00021/00023)      â”‚    â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                                                    â”‚
        â”‚                                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Logging           â”‚â†â”€â”€â”€â”‚ OpenResponses      â”‚    â”‚ Model Mapping      â”‚
â”‚ (015/00020/017)   â”‚    â”‚ (016, retire 004)  â”‚    â”‚ (008 + 014)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†‘                          â”‚
                                  â”‚                          â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Tool History       â”‚â†â”€â”€â”€â”‚ Token Counting     â”‚
                         â”‚ (013/00024/00025)  â”‚    â”‚ (009 + 010 + 019)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Recommended Epoch Structure

### Epoch 1: Token & Context Accuracy (PRIORITY)

**RFCs**: 009, 010, 019 (pause issue)  
**Status**: Core counting complete, compaction & pause mitigation pending  
**Phases**:

1. Validate current token counting accuracy
2. Implement context compaction strategy
3. Address pause issue with tool-choice enforcement or fallback

### Epoch 2: OpenResponses Finalization

**RFCs**: 016 (promote), 017 (narrow to audit)  
**Status**: Architecture complete, logging audit pending  
**Phases**:

1. Promote RFC 016 to Stage 3
2. Complete logging consistency audit
3. Document stream mapping as spec

### Epoch 3: Tool History Unification

**RFCs**: 013, 00024, 00025 (consolidate)  
**Status**: Code exists in `tool-history/`, needs wiring  
**Phases**:

1. Wire ToolHistoryManager into request pipeline
2. Implement native tool history with fallback
3. Add UI indicator for truncation

### Epoch 4: Model Mapping Refinement

**RFCs**: 008 + 014  
**Status**: Complete - needs formal closure  
**Phases**:

1. Promote RFC 008 to Stage 4 (stable)
2. Fold RFC 014 as completed Phase 5
3. Document model capability detection

### Epoch 5: Logging Architecture

**RFCs**: 015, 00020 (consolidate)  
**Status**: Basic logger exists, hierarchical structure pending  
**Phases**:

1. Add structured JSON logging
2. Implement request correlation IDs
3. Session-scoped log directories (optional)

### Epoch 6: Enterprise Controls

**RFCs**: 005, 011, 012  
**Status**: Partial config, partial auth, no telemetry  
**Phases**:

1. Expand configuration surface
2. Implement generic OIDC support
3. Add opt-in telemetry (if desired)

### Epoch 7: Vercel Transition

**RFCs**: 001, 002, 007  
**Status**: Not started (business decision)  
**Phases**:

1. Branding & identity update
2. Repository extraction
3. Migration path & deprecation

### Epoch 8: Future/Research

**RFCs**: 00021, 00023 (consolidate)  
**Status**: Research only  
**Phases**:

1. Track proposed VS Code APIs
2. Implement insiders build strategy (when needed)

---

## Orphaned Implementation (No RFC)

These features exist in code but have no dedicated RFC:

- Model cache persistence + stale-while-revalidate (`models/enrichment.ts`)
- Conservative max context/output caps (`models/model-limits.ts`)
- Special token sanitization (`provider/message-translation.ts`)
- Disguised system prompt extraction (`provider/system-prompt.ts`)

**Recommendation**: Document as implementation details under existing RFCs or create lightweight RFCs if they need evolution.

---

## Immediate Actions

1. **Clean RFC directory**: Retire/archive superseded RFCs
2. **Scaffold new plan.toml**: Use epoch structure above
3. **Update RFC stages**: Promote completed RFCs (016, 019-refactor, 008)
4. **Create consolidated RFCs**: Tool History, Logging Architecture, Proposed APIs

---

## Code Evidence Summary

| Feature             | Files                                   | RFC Coverage      |
| ------------------- | --------------------------------------- | ----------------- |
| Token counting      | `src/tokens/counter.ts`, `lru-cache.ts` | 006, 009          |
| Stream adaptation   | `src/provider/stream-adapter.ts`        | 016, 00022        |
| Message translation | `src/provider/message-translation.ts`   | 006, 016          |
| Tool history        | `src/provider/tool-history/`            | 013, 00024, 00025 |
| Model discovery     | `src/models/models.ts`, `enrichment.ts` | 008, 014          |
| Provider pipeline   | `src/provider/*.ts`                     | 016, 019-refactor |
| Authentication      | `src/auth.ts`, `vercel-auth.ts`         | 011               |
| Configuration       | `src/config.ts`                         | 005               |
| Status bar          | `src/status-bar.ts`                     | 018               |
| Logging             | `src/logger.ts`                         | 015               |
